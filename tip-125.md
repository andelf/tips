---
tip: 125
title: Refine gRPC API Error Response
author: Mono Wang<andelf@gmail.com>
discussions-to: https://github.com/tronprotocol/tips/issues/125
status: Draft
type: Interface
category: gRPC
created: 2020-01-20
---

## Simple Summary

This TIP is to refine all gRPC API Error Responses, providing more meaningful error information for API caller.

## Abstract

The gRPC protocol has a standard status response schema, which provides status code, error message and status details in
binary format. Current Tron implementation does not take advantage of this. By using gRPC's status response with meaningful
status, developers can get a more detailed hint about the underlying error.

## Motivation

The current RPC response can only tell an error via further checking of field availability, which misleads RPC users.
Like [#2761 GetAccount RPC does not return errors correctly](https://github.com/tronprotocol/java-tron/issues/2761).
There are RPC APIs that caller can't distinguish error response from a normal response. Like `GetAccountResource`,
which returns an empty `AccountResourceMessage`. Under many gRPC/protobuf implementations, an empty protobuf structure
will be filled with default values.

Since gRPC already has a usable status response with error details, the Tron's gRPC API implementation can take advantage
of it and provide more meaningful error details.

## Specification

Take `GetAccountResource` as an example.

### Current gRPC Service Implementation

```java
@Override
public void getAccountResource(Account request, StreamObserver<AccountResourceMessage> responseObserver) {
    ByteString fromBs = request.getAddress();

    if (fromBs != null) {
        responseObserver.onNext(wallet.getAccountResource(fromBs));
    } else {
        responseObserver.onNext(null);
    }
    responseObserver.onCompleted();
}
```

### Refined Implementation

```java
import io.grpc.Status;
import io.grpc.StatusException;

@Override
public void getAccountResource(Account request, StreamObserver<AccountResourceMessage> responseObserver) {
    ByteString fromBs = request.getAddress();

    try {
        if (fromBs != null) {
            responseObserver.onNext(wallet.getAccountResource(fromBs));
        } else {
            responseObserver.onError(new StatusException(Status.INVALID_ARGUMENT));
        }
    }
    catch (Exception e) {
        responseObserver.onError(e);
    }
    responseObserver.onCompleted();
}
```

### Selected gRPC Status Codes for Tron

- INVALID_ARGUMENT: for empty argument, illegal argument
- NOT_FOUND: for querying something on-chain
- ALREADY_EXISTS: for creating something on-chain
- PERMISSION_DENIED: for signature error or permission error
- RESOURCE_EXHAUSTED: for insufficient bandwidth or energy
- UNAVAILABLE: for throw requires PROPOSAL to be landed
- FAILED_PRECONDITION: for prerequisite not satisfied
- INTERNAL: underlying errors

### Codes that Shouldn't Use

- CANCELLED: no meaning for Tron
- ABORTED: no meaning for Tron
- DEADLINE_EXCEEDED: no meaning for Tron
- UNAUTHENTICATED: no meaning for Tron, use PERMISSION_DENIED
- OUT_OF_RANGE: use INVALID_ARGUMENT instead
- DATA_LOSS: maybe used by light node for query rpc

### References

- [gRPC Status](https://grpc.github.io/grpc-java/javadoc/io/grpc/Status.html)
- [gRPC StatusException](https://grpc.github.io/grpc-java/javadoc/io/grpc/StatusException.html)
- [gRPC StatusRuntimeException](https://grpc.github.io/grpc-java/javadoc/io/grpc/StatusRuntimeException.html)
- [gRPC StreamObserver](https://grpc.github.io/grpc-java/javadoc/io/grpc/stub/StreamObserver.html)
- [Status codes and their use in gRPC](https://github.com/grpc/grpc/blob/master/doc/statuscodes.md#status-codes-and-their-use-in-grpc)

## Rationale

TODO

## Backwards Compatibility

The gRPC API callers MUST handle gRPC status, instead of checking field availability.
